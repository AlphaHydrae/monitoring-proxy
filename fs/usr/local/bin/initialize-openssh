#!/command/with-contenv sh

log () {
  timestamp="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
  echo "[$timestamp] [ssh] $@"
}

if ls -1 /etc/ssh/ssh_host_* 2>/dev/null; then
  log "Host keys already exist, skipping generation."
else
  log "Generating host keys..."
  /usr/bin/ssh-keygen -A
  log "Generated host keys:"
  ls -1 /etc/ssh/ssh_host_*
fi

log "Testing configuration..."
/usr/sbin/sshd -T
log "Configuration is valid."

for key in /etc/ssh/ssh_host_*_key.pub; do
  log "$key: $(cat "$key")"
done
